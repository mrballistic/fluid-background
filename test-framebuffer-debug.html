<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Framebuffer Debug Test</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #222;
      color: white;
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }
    
    .success { background: rgba(0, 255, 0, 0.2); border: 1px solid #0f0; }
    .error { background: rgba(255, 0, 0, 0.2); border: 1px solid #f00; }
    .info { background: rgba(0, 0, 255, 0.2); border: 1px solid #00f; }
    .warning { background: rgba(255, 255, 0, 0.2); border: 1px solid #ff0; }
  </style>
</head>
<body>
  <h1>WebGL Framebuffer Debug Test</h1>
  <div id="status"></div>
  
  <script>
    const statusDiv = document.getElementById('status');
    
    function addStatus(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `status ${type}`;
      div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      statusDiv.appendChild(div);
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function getStatusName(status) {
      const statusNames = {
        36053: 'FRAMEBUFFER_COMPLETE',
        36054: 'FRAMEBUFFER_INCOMPLETE_MULTISAMPLE',
        36055: 'FRAMEBUFFER_INCOMPLETE_LAYER_TARGETS',
        36057: 'FRAMEBUFFER_INCOMPLETE_ATTACHMENT',
        36058: 'FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT',
        36061: 'FRAMEBUFFER_UNSUPPORTED',
        36182: 'FRAMEBUFFER_INCOMPLETE_DIMENSIONS'
      };
      return statusNames[status] || `UNKNOWN_${status}_0x${status.toString(16)}`;
    }
    
    function testFramebufferCreation(gl, width, height, description) {
      addStatus(`Testing ${description} (${width}x${height})...`, 'info');
      
      const framebuffer = gl.createFramebuffer();
      const texture = gl.createTexture();
      
      if (!framebuffer || !texture) {
        addStatus(`‚ùå Failed to create framebuffer or texture for ${description}`, 'error');
        return false;
      }
      
      try {
        // Create texture
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, width, height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        
        // Attach to framebuffer
        gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);
        
        // Check status
        const status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);
        const statusName = getStatusName(status);
        
        if (status === gl.FRAMEBUFFER_COMPLETE) {
          addStatus(`‚úÖ ${description} successful`, 'success');
          
          // Test basic rendering
          gl.viewport(0, 0, width, height);
          gl.clearColor(0.5, 0.0, 0.5, 1.0);
          gl.clear(gl.COLOR_BUFFER_BIT);
          
          addStatus(`‚úÖ Basic rendering test passed for ${description}`, 'success');
          
          // Clean up
          gl.bindFramebuffer(gl.FRAMEBUFFER, null);
          gl.deleteFramebuffer(framebuffer);
          gl.deleteTexture(texture);
          
          return true;
        } else {
          addStatus(`‚ùå ${description} failed: ${statusName}`, 'error');
          
          // Clean up
          gl.bindFramebuffer(gl.FRAMEBUFFER, null);
          gl.deleteFramebuffer(framebuffer);
          gl.deleteTexture(texture);
          
          return false;
        }
      } catch (error) {
        addStatus(`‚ùå Exception during ${description}: ${error.message}`, 'error');
        
        // Clean up
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);
        gl.deleteFramebuffer(framebuffer);
        gl.deleteTexture(texture);
        
        return false;
      }
    }
    
    function runFramebufferTests() {
      addStatus('Starting framebuffer tests...', 'info');
      
      // Create canvas and WebGL context
      const canvas = document.createElement('canvas');
      canvas.width = 800;
      canvas.height = 600;
      
      const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
      if (!gl) {
        addStatus('‚ùå WebGL not supported', 'error');
        return;
      }
      
      addStatus(`WebGL Version: ${gl.getParameter(gl.VERSION)}`, 'info');
      addStatus(`Vendor: ${gl.getParameter(gl.VENDOR)}`, 'info');
      addStatus(`Renderer: ${gl.getParameter(gl.RENDERER)}`, 'info');
      addStatus(`Max Texture Size: ${gl.getParameter(gl.MAX_TEXTURE_SIZE)}`, 'info');
      addStatus(`Max Renderbuffer Size: ${gl.getParameter(gl.MAX_RENDERBUFFER_SIZE)}`, 'info');
      
      // Test different framebuffer configurations
      const tests = [
        { width: 64, height: 64, desc: 'Small power-of-2' },
        { width: 128, height: 128, desc: 'Medium power-of-2' },
        { width: 256, height: 256, desc: 'Large power-of-2' },
        { width: 100, height: 100, desc: 'Small non-power-of-2' },
        { width: 300, height: 200, desc: 'Medium non-power-of-2' },
        { width: canvas.width, height: canvas.height, desc: 'Canvas size' }
      ];
      
      let successCount = 0;
      
      for (const test of tests) {
        if (testFramebufferCreation(gl, test.width, test.height, test.desc)) {
          successCount++;
        }
      }
      
      addStatus(`\nTest Results: ${successCount}/${tests.length} tests passed`, 
                successCount === tests.length ? 'success' : 'warning');
      
      if (successCount === 0) {
        addStatus('‚ùå All framebuffer tests failed - WebGL may not be properly supported', 'error');
        addStatus('Try updating your graphics drivers or using a different browser', 'warning');
      } else if (successCount < tests.length) {
        addStatus('‚ö†Ô∏è Some framebuffer configurations failed - this may affect fluid simulation', 'warning');
      } else {
        addStatus('üéâ All framebuffer tests passed - fluid simulation should work!', 'success');
      }
    }
    
    // Run tests
    runFramebufferTests();
  </script>
</body>
</html>